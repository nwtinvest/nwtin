function Bond(){return this.name,this.currency="USD",this.daysInYear=365,this.profit=1e3,this.symbol,this.maxPercent=100,this.swap=0,this.ask=0,this.expiration,this.portfolio,this.maxPercentage=100,this}Bond.prototype.setSymbol=function(t){return this.symbol=t,this},Bond.prototype.getSymbol=function(){return this.symbol},Bond.prototype.setCurrency=function(t){return this.currency=t,this},Bond.prototype.setMaxPercent=function(t){return this.maxPercent=t,this},Bond.prototype.getMaxPercent=function(){return this.maxPercent},Bond.prototype.getCurrency=function(){return this.currency},Bond.prototype.setSwap=function(t){return this.swap=t,this},Bond.prototype.getSwap=function(){return this.swap},Bond.prototype.setAsk=function(t){return this.ask=t,this},Bond.prototype.getAsk=function(){return this.ask},Bond.prototype.setPortfolio=function(t){return this.portfolio=t,this},Bond.prototype.getPortfolio=function(){return this.portfolio},Bond.prototype.setExpiration=function(t){return this.expiration=t,this},Bond.prototype.getExpiration=function(){return this.expiration},Bond.prototype.getProfit2expiration=function(){var t=this.getDays2expiration(),o=(this.getSwap()*t+this.profit)/(this.getAsk()/this.getPortfolio().getMaxLeverage()),e=this.daysInYear/t;return(Math.pow(o,e)-1)*this.maxPercentage},Bond.prototype.getLots=function(){},Bond.prototype.getShare=function(){var t=this.getPortfolio().getSumInvestment();return 0==t?0:this.getAmountInPortfolio()/t*this.maxPercentage},Bond.prototype.getCurrentProfit=function(){var t=this.convert(this.getAsk()),o=this.convert(this.getSwap());return 0==t?0:this.daysInYear*o/(t/this.getPortfolio().getMaxLeverage())*this.maxPercent},Bond.prototype.getDays2expiration=function(){return this.getExpiration().diffDays(this.getPortfolio().dateNow())},Bond.prototype.calculateLots=function(){var t=this.convert(this.getAsk());return Math.round(this.getPortfolio().getAmountInvest()*(this.getWeight()/this.maxPercentage)*this.getPortfolio().getLeverage()/t)},Bond.prototype.convert=function(t){var o=this.getPortfolio().getCurrencyConversion();return o.convert(this.getCurrency(),this.getPortfolio().getCurrency(),t)},Bond.prototype.getMaxLots=function(){var t=this.convert(this.getAsk());return Math.floor(this.getPortfolio().freeAmount()/(t/this.getPortfolio().getMaxLeverage()))},Bond.prototype.getAmountInPortfolio=function(){var t=this.convert(this.getAsk());return this.getLots()*t};
function BondController(o,t){this.portfolioRepository=o,this.convertCurrency=t,this.ERROR_MESSAGE_NOT_FOUND="not found the portfolio"}BondController.prototype.getPortfolio=function(o){var t=this.portfolioRepository.getPortfolio(o);if(!t)throw Error(this.ERROR_MESSAGE_NOT_FOUND);return this.initPortfolios(t),t},BondController.prototype.getPortfolios=function(){var o=this,t=this.portfolioRepository.getPortfolios();return $.each(t,function(t,r){o.initPortfolios(r)}),t},BondController.prototype.initPortfolios=function(o){o.setCurrencyConversion(this.convertCurrency),o.calculate(),o.setAmountInvest(o.getMinSumInvestment()),o.calculate()};
function CurrencyConversion(r){this.data={},this.loadUrl=r,this.currencyUSD="USD",this.ERROR_MESSAGE_NOT_FOUND_RATE="Not found the rate for currency conversion."}CurrencyConversion.prototype.init=function(r,t){return this.loadQuotes(r,t)},CurrencyConversion.prototype.loadQuotes=function(r,t){var n=this;return $.ajax({url:this.loadUrl,data:{pair:r},success:function(o){var e=o.message;n.addFromQuotes(r,e),t()}})},CurrencyConversion.prototype.addFromQuotes=function(r,t){for(var n in t)for(var o in r)t[n].name==r[o]&&this.addRate(r[o].substr(0,3),r[o].substr(3,3),t[n].bid)},CurrencyConversion.prototype.addRate=function(r,t,n){this.data[r+t]=n,this.data[t+r]=1/n},CurrencyConversion.prototype.convert=function(r,t,n){if(t!=this.currencyUSD&&r!=this.currencyUSD&&(n=this.convert(r,this.currencyUSD,n),r=this.currencyUSD),r==t)return n;var o=this.data[r+t];if(o)return n*o;throw Error(this.ERROR_MESSAGE_NOT_FOUND_RATE)};
function Portfolio(){return this.id,this.nameRu,this.nameEn,this.volatility,this.currency="USD",this.bonds=[],this.desiredProfitability,this.maxPercent=100,this.maxAmountInvestUSD=1e5,this.amountInvest=this.maxAmountInvestUSD,this.maxLeverage=5,this.minInvestCoefficient=1,this.convertCurrency,this}var PortfolioVolatilityEnum={aggressive:1,moderate:2,balanced:3,getName:function(t,e){switch(t){case this.aggressive:return"ru"==e?"Агрессивная":"Aggressive";case PortfolioVolatilityEnum.moderate:return"ru"==e?"Умеренная":"Moderate";case PortfolioVolatilityEnum.balanced:return"ru"==e?"Сбалансированная":"Balanced"}}};Portfolio.prototype.changeCurrency=function(t){var e=this.getCurrency(),o=this.getCurrencyConversion(),n=o.convert(e,t,this.getAmountInvest());this.setCurrency(t),this.setAmountInvest(n)},Portfolio.prototype.getMaxSumInvestment=function(){return this.getCurrencyConversion().convert("USD",this.getCurrency(),this.maxAmountInvestUSD)},Portfolio.prototype.getVolatilityName=function(t){return PortfolioVolatilityEnum.getName(this.getVolatility(),t)},Portfolio.prototype.setName=function(t){return this.nameRu=t,this},Portfolio.prototype.getName=function(t){if("ru"!=t)switch(this.nameRu){case"Сбалансированный":return"Balanced";case"Стратегические инвестиции":return"Strategic investment";case"Банковский сектор":return"Bank sector";case"Российская промышленность":return"Russian industry";case"Нефтегазовый сектор":return"Oil and gas sector"}return this.nameRu},Portfolio.prototype.setID=function(t){return this.id=t,this},Portfolio.prototype.getID=function(){return this.id},Portfolio.prototype.setVolatility=function(t){return this.volatility=t,this},Portfolio.prototype.getVolatility=function(){return this.volatility},Portfolio.prototype.setCurrency=function(t){return this.currency=t,this},Portfolio.prototype.getCurrency=function(){return this.currency},Portfolio.prototype.setDesiredProfitability=function(t){return this.desiredProfitability=t,this},Portfolio.prototype.getDesiredProfitability=function(){return this.desiredProfitability},Portfolio.prototype.getAmountInvest=function(){return this.amountInvest},Portfolio.prototype.setAmountInvest=function(t){return this.amountInvest=t,this},Portfolio.prototype.getMinInvestCoefficient=function(){return this.minInvestCoefficient},Portfolio.prototype.setMinInvestCoefficient=function(t){return this.minInvestCoefficient=t,this},Portfolio.prototype.getMaxLeverage=function(){return this.maxLeverage},Portfolio.prototype.setMaxLeverage=function(t){return this.maxLeverage=t,this},Portfolio.prototype.getBonds=function(){return this.bonds},Portfolio.prototype.setBonds=function(t){var e=this;return $.each(t,function(t,o){o.setPortfolio(e)}),this.bonds=t,this},Portfolio.prototype.findBondBySymbol=function(t){var e;return $.each(this.getBonds(),function(o,n){if(n.getSymbol()==t)return e=n,!1}),e},Portfolio.prototype.setLeverage=function(t){return this.leverage=t,this},Portfolio.prototype.getLeverage=function(){return this.leverage},Portfolio.prototype.getMaxProfit=function(){return $.map(this.getBonds(),function(t){return t.getWeight()/t.maxPercentage*t.getCurrentProfit()}).sum()},Portfolio.prototype.getSumInvestment=function(){var t=$.map(this.getBonds(),function(t){return t.getAmountInPortfolio()});return t.sum()},Portfolio.prototype.getMinSumInvestment=function(){var t=this.getBonds();t=$.grep(t,function(t){return t.getWeight()>0});var e=$.map(t,function(e){var o=e.convert(e.getAsk());return Math.round(t.length*(e.getWeight()/e.maxPercentage))*o});return 0==this.getLeverage()?0:e.sum()/this.getLeverage()*this.getMinInvestCoefficient()},Portfolio.prototype.getTargetIncome=function(){var t=$.map(this.getBonds(),function(t){var e=t.convert(t.getSwap());return e*t.daysInYear*t.getLots()});return t.sum()},Portfolio.prototype.getIncomeInPercent=function(){return 0==this.getAmountInvest()?0:this.getTargetIncome()/this.getAmountInvest()*this.maxPercent},Portfolio.prototype.calculate=function(){var t=this.getBonds();$.each(t,function(t,e){e.getWeight=function(){return 0}}),t=t.sort(function(t,e){return e.getSwap()-t.getSwap()});var e=0;$.each(t,function(t,o){if(e<o.maxPercentage){var n=o.maxPercentage-e,r=Math.min(n,o.getMaxPercent());o.getWeight=function(){return r}}}),$.each(t,function(t,e){e.getLots=function(){return 0}}),$.each(t,function(t,e){var o=e.calculateLots();o=Math.min(o,e.getMaxLots()),e.getLots=function(){return o}})},Portfolio.prototype.setCurrencyConversion=function(t){return this.currencyConversion=t,this},Portfolio.prototype.getCurrencyConversion=function(){return this.currencyConversion},Portfolio.prototype.dateNow=function(){return new Date},Portfolio.prototype.freeAmount=function(){return this.getAmountInvest()-this.getSumInvestment()/this.getMaxLeverage()},Portfolio.prototype.canBuy=function(){return this.getMinSumInvestment()<=this.getAmountInvest()},Portfolio.prototype.getPotentialIncome=function(){var t=this.getLeverage(),e=$.map(this.getBonds(),function(e){var o=e.convert(e.getSwap()),n=e.convert(e.getAsk()),r=e.daysInYear*o*t/n;return e.getMaxPercent()*r});return e.sum()};
function PortfolioRepository(o){return this.data=[],this.loadUrl=o,this}PortfolioRepository.prototype.init=function(o){return this.loadPortfolios(o)},PortfolioRepository.prototype.getPortfolio=function(o){},PortfolioRepository.prototype.getPortfolios=function(){return this.data},PortfolioRepository.prototype.setPortfolios=function(o,t){this.data=this.parsePortfoliosFromArray(o),t()},PortfolioRepository.prototype.parsePortfoliosFromArray=function(o){var t=[];return $.each(o.portfolios,function(e,r){var i=[],s=r.bonds;$.each(s,function(o,t){var e=(new Bond).setSymbol(t.symbol).setMaxPercent(t.maxPercent).setAsk(t.ask).setExpiration(new Date(t.expiration)).setCurrency(t.currency).setSwap(t.swap/100);i.push(e)});var n=(new Portfolio).setID(r.id).setName(r.name).setLeverage(r.leverage).setVolatility(r.volatility).setMinInvestCoefficient(o.config.minInvestmentCoefficient).setMaxLeverage(o.config.maxLeverage).setBonds(i);t.push(n)}),t},PortfolioRepository.prototype.loadPortfolios=function(o){var t=this;return $.get(t.loadUrl,function(e){t.setPortfolios(e,o)})};
function PortfolioRepositoryMock(){}PortfolioRepositoryMock.prototype.factoryBond=function(t,o,e,i,r,s){return(new Bond).setSymbol(t).setMaxPercent(o).setAsk(e).setExpiration(i).setCurrency(s).setSwap(r/100)},PortfolioRepositoryMock.prototype.getBonds=function(){return[this.factoryBond("A21",30,5287.5,new Date(2021,3,28),74,"USD"),this.factoryBond("G18",20,5312.5,new Date(2018,1,13),61,"EUR"),this.factoryBond("G22",30,5112.5,new Date(2022,2,7),57,"USD"),this.factoryBond("V20",10,5025,new Date(2020,6,9),62,"USD"),this.factoryBond("V22",10,5185,new Date(2020,10,9),51,"USD")]},PortfolioRepositoryMock.prototype.getPortfolios=function(){var t=this,o=[(new Portfolio).setName("Банки").setDesiredProfitability(5).setVolatility(PortfolioVolatilityEnum.aggressive),(new Portfolio).setName("Нефтегаз").setDesiredProfitability(7).setVolatility(PortfolioVolatilityEnum.moderate),(new Portfolio).setName("Промышленность").setDesiredProfitability(8).setVolatility(PortfolioVolatilityEnum.balanced),(new Portfolio).setName("Доходный").setDesiredProfitability(10).setVolatility(PortfolioVolatilityEnum.aggressive)];return $.each(o,function(o,e){e.setBonds(t.getBonds())}),o},PortfolioRepositoryMock.prototype.getPortfolio=function(t){var o=new Portfolio;return o.setCurrency("USD").setBonds(this.getBonds()).setDesiredProfitability(25),o};
Date.prototype.diffDays=function(t){var e=this,r=t,a=864e5,i=Math.abs(r-e.getTime()),n=Math.ceil(i/a);return n},Array.prototype.sum=function(){var t=0;return $.each(this,function(e,r){r=Number(r),t+=isNaN(r)?0:r}),t};