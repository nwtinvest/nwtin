define(["jquery.bxslider","d3","helpers","config"],function(t,e,a,n){function i(t){var a=this;this.data=t.data||[],this.container=t.container||"body",this.item=t.item||"div",this.formatCurrency=function(t){return e.format(",")(t).replace(","," ")+" ₽"},this.change=function(t){e.selectAll(a.container).each(function(n,i){e.select(this).transition().style("display",function(){return a.data[t][i]?"":"none"}).transition().duration(750).style("opacity",function(){return a.data[t][i]?"1":"0"});e.select(this).select(a.item).html(a.formatCurrency(a.data[t][i]))})}}function r(t){var a=this;this.data=t.data||[],this.height=t.height||315,this.width=t.width||315,this.radius=t.radius||Math.min(this.width,this.height)/2,this.container=t.container||"body",this.outerRadius=t.outerRadius||0,this.current=0,this.language=t.language,this.formatCurrency=function(t){return e.format(",")(t).replace(","," ")+" ₽"},this.classCompiler=function(t,e){for(var a=[t],n=e.length,i=0;i<n;i++)a.push(t+"--"+e[i]);return a.join(" ")},this.color=e.scale.category20(),this.nested=e.nest().key(function(t){return t.Scene}).entries(a.data),this.pie=e.layout.pie().value(function(t){return t.value}).sort(null),this.arc=e.svg.arc().innerRadius(0).outerRadius(function(t){return a.radius-a.outerRadius}),this.svg=e.select(a.container).append("svg").attr("width",a.width).attr("height",a.height),this.g=this.svg.append("g").attr("transform","translate("+a.width/2+","+a.height/2+")"),this.defs=this.g.append("defs"),this.group=this.g.datum(a.nested[0].values).selectAll("path").data(a.pie).enter().append("g"),this.path=this.group.append("path").attr("class",function(t){return a.classCompiler("invest-path",t.data["class"])}).attr("d",a.arc).each(function(t){this._current=t}),this.tolltipGroup=e.select(a.container).append("div").attr("class","tooltip-container"),this.tooltip=this.tolltipGroup.datum(a.nested[0].values).selectAll("div").data(a.pie).enter().append("div").attr("class",function(t){return a.classCompiler("tooltip",t.data["class"])}).style("transform",function(t){var e=a.arc.centroid(t),n=f?t.data.offsetX:t.data.offsetX/1.5,i=f?t.data.offsetY:t.data.offsetY/1.5;return"translate("+parseInt(e[0]+n)+"px,"+parseInt(e[1]+i)+"px)"}).style("opacity",function(t){return t.data.showTitle?"1":"0"}),this.tooltipValue=this.tooltip.append("div").attr("class","tooltip__value").html(function(t){return a.formatCurrency(t.data.value)}).style("display",function(t){return t.data.showValue?"inline-block":"none"}),this.tooltipLabel=this.tooltip.append("div").attr("class","tooltip__label").html(function(t){return t.data.label[a.language]}),this.createFilter=function(){a.svg.attr("filter","url(#boxshadow)"),a.filter=a.defs.append("filter").attr("id","boxshadow").attr("x","-20%").attr("y","-20%").attr("height","140%").attr("width","140%"),a.filter.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",20).attr("result","blur"),a.filter.append("feOffset").attr("in","blur").attr("dx",0).attr("dy",0).attr("result","offsetBlur"),a.feComponentTransfer=a.filter.append("feComponentTransfer"),a.feComponentTransfer.append("feFuncA").attr("type","linear").attr("slope","0.3"),a.feMerge=a.filter.append("feMerge"),a.feMerge.append("feMergeNode"),a.feMerge.append("feMergeNode").attr("in","SourceGraphic")},this.arcTween=function(t){var n=e.interpolate(this._current,t);return this._current=n(0),function(t){return a.arc(n(t))}},this.update=function(t){a.width=t.width,a.height=t.height,a.radius=t.radius||Math.min(a.width,a.height)/2,a.outerRadius=t.outerRadius,a.svg.attr("width",a.width).attr("height",a.height),a.g.attr("transform","translate("+a.width/2+","+a.height/2+")"),a.change(a.current)},this.change=function(t){a.current=t,a.g.datum(a.nested[a.current].values),a.tolltipGroup.datum(a.nested[a.current].values),this.path.data(a.pie).attr("class",function(t){return a.classCompiler("invest-path",t.data["class"])}).transition().duration(750).attrTween("d",a.arcTween),this.tooltip.data(a.pie).style("transform",function(t){var e=a.arc.centroid(t),n=f?t.data.offsetX:t.data.offsetX/1.5,i=f?t.data.offsetY:t.data.offsetY/1.5;return"translate("+parseInt(e[0]+n)+"px,"+parseInt(e[1]+i)+"px)"}).transition().duration(function(t){return t.data.showTitle?750:0}).style("opacity",function(t){return t.data.showTitle?1:0}),this.tooltipLabel.data(a.pie).html(function(t){return t.data.label[a.language]}),this.tooltipValue.data(a.pie).html(function(t){return a.formatCurrency(t.data.value)}).style("display",function(t){return t.data.showValue?"inline-block":"none"})}}function s(t){$.get(t).done(function(t){o(t.layer1,t.layer2,t.counterData)})}function o(t,e,s){var o,u=$(".invest-process"),g={height:f?315:222,width:f?315:222,container:".invest-graph",language:n.localeSite};d=new r({data:t,height:g.height,width:g.width,container:g.container,outerRadius:0,language:g.language}),h=new r({data:e,height:g.height,width:g.width,container:g.container,outerRadius:f?40:26,language:g.language}),c=new i({data:s,container:".invest-counter",item:".invest-counter__value"}),p.resize(function(){f=a.isDesktop(),o=f?315:222,d.update({height:o,width:o,outerRadius:0}),h.update({height:o,width:o,outerRadius:f?40:26})}),u.addClass("invest-process--init"),l()}function u(){var t,e=$(".bx-controls-direction");e.on("touchstart",function(i){a.isMobile()&&(t=i.originalEvent.touches[0].pageX,e.on("touchmove",n))}),e.on("touchend",function(t){e.off("touchmove",n)}),e.on("swipe",function(t,a){e.off("touchmove",n),a<0?g.goToNextSlide():g.goToPrevSlide()});var n=function(a){var n=a.originalEvent.touches[0].pageX-t;(n<-50||n>50)&&e.trigger("swipe",[n])}}function l(){var t;g=g.bxSlider({mode:"fade",onSliderLoad:function(){c.change(0),h.createFilter(),t=$(this).parents(".bx-wrapper").find(".bx-prev"),t.addClass("disabled"),u()},onSlideBefore:function(e,a,n){h.change(n),d.change(n),c.change(n),0==n?t.addClass("disabled"):t.removeClass("disabled")}})}var d,h,c,p=$(window),f=a.isDesktop(),g=$(".invest-slider");$toggleBtn=$(".invest-text__button--detail"),$toggleBtn.on("click",function(t){t.preventDefault(),e.select(".invest-process__preview").transition().duration(750).style("opacity",0).transition().style("display","none")}),s("/invest-slider")});